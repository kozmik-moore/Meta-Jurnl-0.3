#: import Factory kivy.factory.Factory
#: import GenericLabel base_widgets.GenericLabel
#: import GenericAlignedTextInput base_widgets.GenericAlignedTextInput
#: import notransition kivy.uix.screenmanager.NoTransition
#: set light_blue (0, .5, .8, 1)
#: set dark_gray (.1, .1, .1, .5)
#: set transparent (0, 0, 0, 0)

<TagButton>:
    category: ''
    sorter: None
    screen: ''
    on_release:
        root.sorter.add_tag_to_filtered(self.text) if root.category == 'unfiltered' else root.sorter.filtered_tags.remove(self.text)

<TagLabel>:
    background_color: transparent
#    canvas.before:
#        Color:
#            rgba: (1, 1, 1, 1)
#        Line:
#            width: 1
#            rectangle: self.x, self.y, self.width, self.height

<TagFilterModule>:
    searchbox: searchbox
    BoxLayout:
        orientation: 'vertical'
        BoxLayout:
            AnchorLayout:
                GenericLabel:
                    text: 'None' if len(root.unfiltered_data) == 0 else ''
                GenericRecycleView:
                    id: unfiltered
                    data: root.unfiltered_data
                    viewclass: 'TagButton'
            AnchorLayout:
                GenericLabel:
                    text: 'None' if len(root.filtered_data) == 0 else ''
                GenericRecycleView:
                    id: filtered
                    data: root.filtered_data
                    viewclass: 'TagButton'
        BoxLayout:
            size_hint_y: None
            height: 35
            GenericInput:
                id: searchbox
                background_color: 0.1, 0.1, 0.1, 1
                size_hint_x: 2
                focus: True
                text: ''
                multiline: False
                hint_text: 'Search or add tags'
                on_text:
                    root.search(self.text)
            GenericButton:
                size_hint_x: 1
                width: 90
                text: 'Clear'
                disabled: True if not root.searchbox.text else False
                on_release:
                    root.clear_search_bar()
                    root.searchbox.text = ''
            GenericButton:
                size_hint_x: 1
                width: 90
                text: 'Add'
                disabled: True if not root.searchbox.text else False
                on_release:
                    root.add_to_filtered_tags(root.searchbox.text)

<DateButton>:
    entry_id: -1
    caller: None
#    s_id: root.caller.selected_id if root.caller else -2
#    background_color: light_blue if root.entry_id == root.s_id else (.4, .4, .4, 1)
    on_release:
        root.caller.entry_id = self.entry_id

<DateFilterModule>:
    orientation: 'vertical'
    GridLayout:
        cols: 2
        size_hint_y: None
        height: 35
        GenericLabel:
            text: 'Continuous Time Interval'
            text_size: self.size
            halign: 'right'
            valign: 'center'
        CheckBox:
            size_hint: None, None
            size: 35, 35
            active: root.continuous_range
            on_active:
                root.continuous_range = self.active
    SlideBox:
        label: 'Years'
        label_list: root.years
        min_value: root.year[0] if root.year else 0
        max_value: root.year[1] if root.year else 0
        on_min_value:
            root.year[0] = int(self.min_value)
        on_max_value:
            root.year[1] = int(self.max_value)
    SlideBox:
        decoupled_values: root.continuous_range
        label: 'Months'
        label_list: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec']
        min_value: root.month[0] if root.month else 0
        max_value: root.month[1] if root.month else 0
        on_min_value:
            root.month[0] = int(self.min_value)
        on_max_value:
            root.month[1] = int(self.max_value)
    SlideBox:
        decoupled_values: root.continuous_range
        label: 'Days'
        label_list: [str(x) for x in range(1, 32)]
        min_value: root.day[0] if root.day else 0
        max_value: root.day[1] if root.day else 0
        on_min_value:
            root.day[0] = int(self.min_value)
        on_max_value:
            root.day[1] = int(self.max_value)
    SlideBox:
        decoupled_values: root.continuous_range
        label: 'Hours'
        label_list: ['{:02d}'.format(x) for x in range(24)]
        min_value: root.hour[0] if root.hour else 0
        max_value: root.hour[1] if root.hour else 0
        on_min_value:
            root.hour[0] = int(self.min_value)
        on_max_value:
            root.hour[1] = int(self.max_value)
    SlideBox:
        decoupled_values: root.continuous_range
        label: 'Minutes'
        label_list: ['{:02d}'.format(x) for x in range(60)]
        min_value: root.minute[0] if root.minute else 0
        max_value: root.minute[1] if root.minute else 0
        on_min_value:
            root.minute[0] = int(self.min_value)
        on_max_value:
            root.minute[1] = int(self.max_value)
    SlideBox:
        decoupled_values: root.continuous_range
        disable_on_decouple: True
        label: 'Weekdays'
        label_list: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
        min_value: root.weekday[0] if root.weekday else 0
        max_value: root.weekday[1] if root.weekday else 0
        on_min_value:
            root.weekday[0] = int(self.min_value)
        on_max_value:
            root.weekday[1] = int(self.max_value)

<ReadingModule>:
    BoxLayout:
        size_hint_x: None
        width: 225
        orientation: 'vertical'
        padding: 5
        spacing: 2
        canvas.before:
            Color:
                rgba: light_blue
            Line:
                width: 1
                rectangle: self.x, self.y, self.width, self.height
        MenuButton:
            size_hint_x: 1
            text: 'Select Filters'
            on_release:
                root.call_filter_popup()
        GenericRecycleView:
            viewclass: 'DateButton'
            data: root.filtered_dates_data
        MenuButton:
            text: 'Stats: ' + root.proportion
    BoxLayout:
        orientation: 'vertical'
        padding: 5
        spacing: 2
        canvas.before:
            Color:
                rgba: light_blue
            Line:
                width: 1
                rectangle: self.x, self.y, self.width, self.height
        GenericLabel:
            text: root.date
        ScrollView:
            do_scroll_x: False
            do_scroll_y: True
            size_hint_y: 1
            GenericInput:
                background_color: 0, 0, 0, 1
                size_hint_y: None
                height: self.minimum_height
                size_hint_x: 1
                text: root.body
                on_text:
                    self.parent.scroll_y = 1
                readonly: True
        BoxLayout:
            size_hint_y: None
            height: self.minimum_height
            MenuButton:
                text: 'Edit'
                disabled: True if root.entry_id == -1 else False
                on_release:
                    root.set_edit_property()
            MenuButton:
                text: 'Link'
                disabled: True if root.entry_id == -1 else False
                on_release:
                    root.set_link_property()
            MenuButton:
                size_hint_x: 1
                text: 'Clear' if self.width > 50 else 'Cl'
                disabled: True if root.entry_id == -1 else False
                on_release:
                    root.clear_ui()
    BoxLayout:
        size_hint_x: None
        width: 225
        padding: 5
        spacing: 2
        canvas.before:
            Color:
                rgba: light_blue
            Line:
                width: 1
                rectangle: self.x, self.y, self.width, self.height
        orientation: 'vertical'
        AnchorLayout:
            size_hint_y: None
            height: 111
            anchor_y: 'top'
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: 2
                MenuButton:
                    size_hint_x: 1
                    text: 'Parent'
                    disabled: True if root.has_parent is False else False
                    on_release:
                        root.entry_id = root.parent_id
                MenuButton:
                    size_hint_x: 1
                    text: 'Children'
                    disabled: True if root.has_children is False else False
                    on_release:
                        root.call_children_popup()
                MenuButton:
                    size_hint_x: 1
                    text: 'Attachments'
                    disabled: True if root.has_attachments is False else False
                    on_release:
                        root.call_attachments_popup()
        BoxLayout:
            size_hint_y: None
            height: 35
        BoxLayout:
            size_hint_y: None
            height: 25
            spacing: 2
            BoxLayout:
            GenericLabel:
                canvas.before:
                    Color:
                        rgba: 1, 1, 1, 1
                    Line:
                        width: 1
                        rectangle: self.x, self.y, self.width, self.height
                text: 'Tags'
                size_hint: None, None
                size: self.parent.width - 35, self.texture_size[1] + 5
            BoxLayout:
        AnchorLayout:
            anchor_y: 'bottom'
            GenericRecycleView:
                data: root.entry_tags_data
                viewclass: 'TagLabel'

<FiltersPopup>:
    pos_hint: {'x': 0}
    size_hint_x: None
    width: 400
    title: 'Filters'
    BoxLayout:
        orientation: 'vertical'
        spacing: 2
        padding: 0, 1
        Spinner:
            option_cls: 'SpinnerButton'
            background_color: dark_gray
            text: 'Tags' if not root.current_screen else root.current_screen
            bold: True
            values: 'Tags', 'Dates', 'Attributes'
            size_hint: 1, None
            size: 200, 35
            on_text:
                root.current_screen = self.text
        BoxLayout:
            padding: 1, 2
            ScreenManager:
                id: screen_manager
                transition: notransition()
                current: root.current_screen
                Screen:
                    name: 'Tags'
                    BoxLayout:
                        orientation: 'vertical'
                        BoxLayout:
                            size_hint_y: None
                            height: self.minimum_height
                            Spinner:
                                option_cls: 'SpinnerButton'
                                background_color: dark_gray
                                bold: True
                                text: root.tags_filter_type
                                values: 'Contains One Of...', 'Contains At Least...', 'Contains Only...', 'Untagged'
                                size_hint: 1, None
                                size: 200, 35
                                on_text:
                                    root.tags_filter_type = self.text
                            Spinner:
                                option_cls: 'SpinnerButton'
                                background_color: dark_gray
                                text: 'Mass Select'
                                bold: True
                                values: 'All', 'None', 'Invert'
                                size_hint: 1, None
                                size: 200, 35
                                on_text:
                                    root.mass_select = self.text
                                    self.text = 'Mass Select'
                        TagFilterModule:
                            id: tag_filter_module
                            filtered_tags: root.filtered_tags
                            database: root.database if root.database else None
                Screen:
                    name: 'Dates'
                    DateFilterModule:
                        id: date_filter_module
                        years: root.years
                        continuous_range: root.continuous_range
                        on_continuous_range:
                            root.continuous_range = self.continuous_range
                        ranges: root.ranges
                Screen:
                    name: 'Attributes'
                    AnchorLayout:
                        anchor_y: 'top'
                        GridLayout:
                            size_hint_y: None
                            height: self.minimum_height
                            cols: 2
                            rows: 2
                            BoxLayout:
                                size_hint_y: None
                                height: self.minimum_height
                                Label:
                                    text: 'Has Parent'
                                    text_size: self.size
                                    halign: 'center'
                                    valign: 'center'
                                CheckBox:
                                    size_hint: None, None
                                    size: 35, 35
                                    active: root.has_parent
                                    on_active:
                                        root.has_parent = self.active
                            BoxLayout:
                                size_hint_y: None
                                height: self.minimum_height
                                Label:
                                    text: 'Has Children'
                                    text_size: self.size
                                    halign: 'center'
                                    valign: 'center'
                                CheckBox:
                                    size_hint: None, None
                                    size: 35, 35
                                    active: root.has_children
                                    on_active:
                                        root.has_children = self.active
                            BoxLayout:
                                size_hint_y: None
                                height: self.minimum_height
                                Label:
                                    text: 'Has Attachments'
                                    text_size: self.size
                                    halign: 'center'
                                    valign: 'center'
                                CheckBox:
                                    size_hint: None, None
                                    size: 35, 35
                                    active: root.has_attachments
                                    on_active:
                                        root.has_attachments = self.active
                            BoxLayout:
                                size_hint_y: None
                                height: self.minimum_height
                                Label:
                                    text: 'Body Contains...'
                                    text_size: self.size
                                    halign: 'center'
                                    valign: 'center'
                                CheckBox:
                                    size_hint: None, None
                                    size: 35, 35
                                    active: root.has_body
                                    on_active:
                                        root.has_body = self.active
        AnchorLayout:
            size_hint_y: None
            height: 35
            anchor_x: 'center'
            GenericButton:
                text: 'Clear Filters'
                on_release:
                    root.clear_filters()

<SpinnerButton>:
    size_hint_x: 1
    background_color: .3, .3, .3, 1
    canvas.before:
        Color:
            rgba: 0, 0, 0, 1
        Line:
            width: 2
            rectangle: self.x, self.y, self.width, self.height

<ChildrenPopup>:
    size_hint_x: None
    width: 300
    pos_hint: {'right': 1}
    title: 'Children for:\n{}'.format(root.date)
    searchbox: searchbox
    BoxLayout:
        spacing: 2
        orientation: 'vertical'
        GenericRecycleView:
            data: root.children_data
            viewclass: 'ChildButton'
        AnchorLayout:
            size_hint_y: None
            height: 35
            anchor_x: 'center'
            GenericButton:
                size_hint_x: None
                width: 150
                text: 'Tree Graph'
        BoxLayout:
            size_hint_y: None
            height: 35
            GenericInput:
                id: searchbox
                focus: True
                text: ''
                multiline: False
                hint_text: 'Search dates'
                on_text:
                    root.search_text = self.text
            GenericButton:
                size_hint_x: None
                width: 90
                text: 'Clear'
                disabled: True if not root.searchbox.text else False
                on_release:
                    root.searchbox.text = ''

<ChildButton>:
    entry_id: -1
    caller: None
    on_release:
        root.caller.selected_id = self.entry_id
        root.caller.dismiss()

<AttachmentsPopup>:
    size_hint_x: None
    width: 300
    pos_hint: {'right': 1}
    title: 'Children for:\n{}'.format(root.date)
    searchbox: searchbox
    BoxLayout:
        orientation: 'vertical'
        GenericRecycleView:
            data: root.attachments_data
            viewclass: 'AttachmentButton'
        BoxLayout:
            size_hint_y: None
            height: 35
            GenericInput:
                id: searchbox
                focus: True
                text: ''
                multiline: False
                hint_text: 'Search for attachments'
                on_text:
                    root.search_text = self.text
            GenericButton:
                size_hint_x: None
                width: 90
                text: 'Clear'
                disabled: True if not root.searchbox.text else False
                on_release:
                    root.searchbox.text = ''

<AttachmentButton>:
    att_id: -1
    added: None     # add support for searching by date added
    caller: None
    name: ''
    on_release:
        root.caller.export_file(self.att_id, self.name)

<ShortMessagePopup>:
    size_hint: None, None
    size: 400, 200
    padding: 15
    AnchorLayout:
        anchor_x: 'center'
        anchor_y: 'center'
        BoxLayout:
            size_hint_y: None
            height: self.minimum_height
            orientation: 'vertical'
            spacing: 30
            GenericLabel:
                text: root.message
                text_size: root.width - 30, None
                size: self.texture_size
            AnchorLayout:
                anchor_x: 'center'
                GenericButton:
                    text: 'OK'
                    on_release:
                        root.dismiss()

<SlideBox>:
    lo: lo_slide
    hi: hi_slide
    slide_size_hint: 2
    orientation: 'horizontal'
    canvas.before:
        Color:
            rgba: .6, .6, .6, 1
        Line:
            width: 1
            rectangle: self.x, self.y, self.width, self.height
    AnchorLayout:
        anchor_x: 'center'
        anchor_y: 'center'
        size_hint_x: .25
        Label:
            text: root.label
            size_hint: 0.7, None
            height: 35
    GridLayout:
        padding: 20, 0, 0, 0
        rows: 2
        cols: 2
        Slider:
            disabled: True if root.disable_on_decouple is True and root.decoupled_values is True else False
            id: lo_slide
            size_hint_x: root.slide_size_hint
            min: root.min_range
            max: root.max_range
            step: 1
            value: root.min_value
            on_value:
                if self.value > root.hi.value and not root.decoupled_values: root.hi.value = self.value
                root.min_value = self.value
        Label:
            text: '' if not root.label_list else str(root.label_list[int(root.lo.value)])
            halign: 'right'
        Slider:
            disabled: True if root.disable_on_decouple is True and root.decoupled_values is True else False
            id: hi_slide
            size_hint_x: root.slide_size_hint
            min: root.min_range
            max: root.max_range
            step: 1
            value: root.max_value
            on_value:
                if root.lo.value > self.value and not root.decoupled_values: root.lo.value = self.value
                root.max_value = self.value
        Label:
            text: '' if not root.label_list else str(root.label_list[int(root.hi.value)])
            halign: 'right'

<MenuButton>:
    background_color: .3, .3, .3, 1
    color: light_blue
#    canvas.before:
#        Color:
#            rgba: (1, 1, 1, 1)
#        Line:
#            width: 1
#            rectangle: self.x, self.y, self.width, self.height